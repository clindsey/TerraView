<!DOCTYPE html>

<html>
<head>
  <title>Viewport.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="config.html">
                app/config.coffee
              </a>
            
              
              <a class="source" href="index.html">
                app/index.coffee
              </a>
            
              
              <a class="source" href="lib_utils.html">
                app/lib/utils.coffee
              </a>
            
              
              <a class="source" href="models_Creature.html">
                app/models/Creature.coffee
              </a>
            
              
              <a class="source" href="models_Heightmap.html">
                app/models/Heightmap.coffee
              </a>
            
              
              <a class="source" href="models_HeightmapChunk.html">
                app/models/HeightmapChunk.coffee
              </a>
            
              
              <a class="source" href="models_Tile.html">
                app/models/Tile.coffee
              </a>
            
              
              <a class="source" href="models_TileMap.html">
                app/models/TileMap.coffee
              </a>
            
              
              <a class="source" href="models_Viewport.html">
                app/models/Viewport.coffee
              </a>
            
              
              <a class="source" href="models_base_Model.html">
                app/models/base/Model.coffee
              </a>
            
              
              <a class="source" href="views_Creature.html">
                app/views/Creature.coffee
              </a>
            
              
              <a class="source" href="views_EntityManager.html">
                app/views/EntityManager.coffee
              </a>
            
              
              <a class="source" href="views_Stage.html">
                app/views/Stage.coffee
              </a>
            
              
              <a class="source" href="views_Tile.html">
                app/views/Tile.coffee
              </a>
            
              
              <a class="source" href="views_Viewport.html">
                app/views/Viewport.coffee
              </a>
            
              
              <a class="source" href="views_base_View.html">
                app/views/base/View.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Viewport.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>View = require <span class="string">"views/base/View"</span>
TileModel = require <span class="string">"models/Tile"</span>
TileView = require <span class="string">"views/Tile"</span>
utils = require <span class="string">"lib/utils"</span>
config = require <span class="string">"config"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Responds to keyboard and mouse navigation
Adds and manages tiles
Uses an external source for tile data
Tiles are not created and destroyed every time the viewport moves, instead the existing tile views are updated.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
module.exports = View.extend <span class="string">"ViewportView"</span>,
    create: (viewportModel, tileMapModel) -&gt;
      view = <span class="property">@_super</span>()

      view.model = viewportModel

      view.el = <span class="keyword">new</span> createjs.Container

      view.tileMapModel = tileMapModel

      view.tileModels = <span class="property">@buildTileModels</span> view
      view.tileViews = <span class="property">@buildTileViews</span> view
      view.el.addChild(tileView.el) <span class="keyword">for</span> tileView <span class="keyword">in</span> view.tileViews

      EventBus.addEventListener <span class="string">"!key:down"</span>, view.onKeyDown, view
      EventBus.addEventListener <span class="string">"!mouse:down"</span>, view.onMouseDown, view

      EventBus.addEventListener <span class="string">"!move:<span class="subst">#{view.model.uniqueId}</span>"</span>, view.drawMap, view

      view

    buildTileModels: (view) -&gt;
      tileMapModel = view.tileMapModel
      model = view.model
      tileMapData = tileMapModel.getArea model.width, model.height, model.x, model.y

      tiles = []

      <span class="keyword">for</span> y <span class="keyword">in</span> [<span class="number">0.</span>.tileMapData.length - <span class="number">1</span>]
        <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0.</span>.tileMapData[y].length - <span class="number">1</span>]
          tileModel = TileModel.create tileMapData[y][x], x, y

          tiles.push tileModel

      tiles

    buildTileViews: (view, img) -&gt;
      views = []

      _.each view.tileModels, (tileModel) -&gt;
        tileView = TileView.create tileModel, img

        tileView.el.x = tileModel.x * config.tileWidth
        tileView.el.y = tileModel.y * config.tileHeight

        views.push tileView

      views
  ,
    drawMap: -&gt;
      tileMapData = <span class="property">@tileMapModel</span>.getArea <span class="property">@model</span>.width, <span class="property">@model</span>.height, <span class="property">@model</span>.x, <span class="property">@model</span>.y

      <span class="keyword">for</span> y <span class="keyword">in</span> [<span class="number">0.</span>.tileMapData.length - <span class="number">1</span>]
        <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0.</span>.tileMapData[y].length - <span class="number">1</span>]
          tileModel = <span class="property">@tileModels</span>[x + tileMapData[y].length * y]

          tileModel.setIndex tileMapData[y][x]</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Splits the canvas quadrants for clicks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onMouseDown: (_event, args) -&gt;
      halfWidth = Math.floor(<span class="property">@model</span>.width / <span class="number">2</span>) * config.tileWidth
      halfHeight = Math.floor(<span class="property">@model</span>.height / <span class="number">2</span>) * config.tileHeight

      dx = args.stageX - halfWidth
      dy = args.stageY - halfHeight

      direction = Math.abs (Math.atan2(dx, dy) / Math.PI * <span class="number">180</span>) - <span class="number">180</span>

      keyCode = <span class="number">37</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>North, east, south, west</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> <span class="number">315</span> &lt; direction <span class="keyword">or</span> direction &lt; <span class="number">45</span>
        keyCode = <span class="number">38</span>
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">45</span> &lt; direction &lt; <span class="number">135</span>
        keyCode = <span class="number">39</span>
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">135</span> &lt; direction &lt; <span class="number">225</span>
        keyCode = <span class="number">40</span>
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="number">225</span> &lt; direction &lt; <span class="number">315</span>
        keyCode = <span class="number">37</span>

      EventBus.dispatch <span class="string">"!key:down"</span>, @, {keyCode}

    onKeyDown: (_event, args) -&gt;
      x = <span class="property">@model</span>.x
      y = <span class="property">@model</span>.y

      <span class="keyword">switch</span> args.keyCode
        <span class="keyword">when</span> <span class="number">37</span>
          x = <span class="property">@model</span>.x - <span class="number">1</span>
          x = utils.clamp x, config.worldTileWidth
        <span class="keyword">when</span> <span class="number">38</span>
          y = <span class="property">@model</span>.y - <span class="number">1</span>
          y = utils.clamp y, config.worldTileHeight
        <span class="keyword">when</span> <span class="number">39</span>
          x = <span class="property">@model</span>.x + <span class="number">1</span>
          x = utils.clamp x, config.worldTileWidth
        <span class="keyword">when</span> <span class="number">40</span>
          y = <span class="property">@model</span>.y + <span class="number">1</span>
          y = utils.clamp y, config.worldTileHeight

      <span class="property">@model</span>.setPosition x, y

    dispose: -&gt;
      _.each <span class="property">@tileModels</span>, (tileModel) -&gt;
        tileModel.dispose()

      _.each <span class="property">@tileViews</span>, (tileView) -&gt;
        tileView.dispose()

      EventBus.removeEventListener <span class="string">"!move:<span class="subst">#{@model.uniqueId}</span>"</span>, <span class="property">@drawMap</span>, @

      EventBus.removeEventListener <span class="string">"!key:down"</span>, <span class="property">@onKeyDown</span>, @
      EventBus.removeEventListener <span class="string">"!mouse:down"</span>, <span class="property">@onMouseDown</span>, @

      <span class="property">@_super</span>()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
